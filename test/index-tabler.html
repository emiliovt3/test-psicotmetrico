<!doctype html>
<!--
* Evaluación Psicométrica - Sistema de Contratación
* Basado en Tabler Framework - Template Wizard
-->
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Evaluación Psicométrica - Anuncios Luminosos</title>
    
    <!-- Tabler CSS -->
    <link href="../admin/dist/css/tabler.css" rel="stylesheet" />
    <link href="../admin/dist/css/theme-custom.css" rel="stylesheet" />
    
    <style>
        @import url('https://rsms.me/inter/inter.css');
        
        /* Variables personalizadas */
        :root {
            --primary-color: #066fd1;
            --success-color: #2fb344;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        /* Auto-save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        /* Loading states */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Results card animations */
        .card {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Badge improvements */
        .badge-lg {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
        }
        
        /* Section progress */
        .section-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 2rem;
        }
        
        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border: 2px solid #e6e6e6;
            background: #f8f9fa;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .progress-step.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .progress-step.completed {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .progress-line {
            width: 60px;
            height: 2px;
            background: #e6e6e6;
            transition: background 0.3s;
        }
        
        .progress-line.completed {
            background: var(--success-color);
        }
        
        /* Question styles */
        .question-card {
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .question-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .question-number {
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 0.5rem;
        }
        
        .question-body {
            padding: 1.5rem;
        }
        
        /* CLEAVER specific styles */
        .cleaver-words {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .word-card {
            text-align: center;
            padding: 1rem;
            border: 2px solid #e6e6e6;
            border-radius: 0.5rem;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .word-card.selected-mas {
            border-color: var(--primary-color);
            background: rgba(6, 111, 209, 0.1);
        }
        
        .word-card.selected-menos {
            border-color: var(--danger-color);
            background: rgba(220, 53, 69, 0.1);
        }
        
        .word-card.selected-both {
            border-color: var(--warning-color);
            background: rgba(255, 193, 7, 0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .word-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 0.5rem;
        }
        
        .word-text {
            font-weight: 500;
            color: #495057;
        }
        
        /* Choice section */
        .choice-section {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: start;
            width: 100%;
            min-height: 120px;
        }
        
        .choice-column {
            text-align: center;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        .choice-column:first-child {
            justify-self: center;
        }
        
        .choice-column:last-child {
            justify-self: center;
        }
        
        .choice-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
        }
        
        .choice-label.mas {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
        }
        
        .choice-label.menos {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
            color: white;
        }
        
        .choice-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .choice-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
            color: #6c757d;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .choice-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .choice-btn.selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }
        
        .choice-column:last-child .choice-btn.selected {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .choice-separator {
            width: 2px;
            height: 80px;
            background: linear-gradient(to bottom, #dee2e6, #adb5bd, #dee2e6);
            border-radius: 1px;
        }
        
        /* Navigation buttons */
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }
        
        /* Desktop styles - default */
        @media (min-width: 769px) {
            .container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
            
            .choice-grid {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 3rem;
                align-items: start;
            }
            
            .choice-separator {
                width: 3px;
                height: 100px;
                background: linear-gradient(to bottom, #dee2e6, #adb5bd, #dee2e6);
            }
            
            .cleaver-words {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
            
            .choice-btn {
                width: 50px;
                height: 50px;
                font-size: 16px;
            }
            
            .choice-buttons {
                gap: 1rem;
            }
        }
        
        /* Tablet responsive */
        @media (max-width: 768px) and (min-width: 481px) {
            .container {
                padding: 1rem;
            }
            
            .choice-grid {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 2rem;
                align-items: start;
            }
            
            .choice-separator {
                width: 2px;
                height: 80px;
            }
            
            .cleaver-words {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .choice-buttons {
                gap: 0.75rem;
            }
            
            .choice-btn {
                width: 45px;
                height: 45px;
            }
        }
        
        /* Mobile responsive */
        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            
            .choice-grid {
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
            }
            
            .choice-separator {
                width: 80px;
                height: 2px;
                align-self: center;
                margin: 0 auto;
            }
            
            .cleaver-words {
                grid-template-columns: 1fr;
            }
            
            .choice-buttons {
                gap: 0.5rem;
            }
            
            .choice-btn {
                width: 45px;
                height: 45px;
            }
            
            .form-footer {
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-footer .btn {
                width: 100%;
            }
            
            .choice-label {
                font-size: 14px;
                padding: 0.375rem 0.75rem;
            }
        }
        
        /* Card styling improvements */
        .card-lg {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Hidden sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Auto-save indicator -->
    <div class="save-indicator" id="saveIndicator">
        ✓ Guardado automáticamente
    </div>
    
    <!-- Network status indicator -->
    <div class="save-indicator" id="networkIndicator" style="background: var(--warning-color); color: #000; display: none; right: 20px; top: 60px;">
        ⚠️ Sin conexión - Guardando localmente
    </div>
    
    <!-- Loading screen -->
    <div class="page page-center" id="loadingScreen">
        <div class="container py-4">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h3>Verificando credenciales...</h3>
                <p class="text-secondary">Por favor espere mientras validamos su token de acceso</p>
            </div>
        </div>
    </div>
    
    <!-- Error screen -->
    <div class="page page-center" id="errorScreen" style="display: none;">
        <div class="container py-4">
            <div class="text-center">
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-danger" width="64" height="64" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                        <circle cx="12" cy="12" r="9"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                </div>
                <h3 class="text-danger">Error de Acceso</h3>
                <p class="text-secondary mb-3" id="errorMessage">Token inválido o expirado</p>
                <div class="alert alert-warning">
                    <strong>¿Qué hacer?</strong><br>
                    • Verifique que el enlace sea correcto<br>
                    • Solicite un nuevo enlace a su supervisor<br>
                    • Contacte al departamento de recursos humanos
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success screen -->
    <div class="page page-center" id="successScreen" style="display: none;">
        <div class="container py-4">
            <div class="text-center">
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-success" width="64" height="64" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                        <circle cx="12" cy="12" r="9"/>
                        <path d="m9 12l2 2l4 -4"/>
                    </svg>
                </div>
                <h3 class="text-success">Evaluación Completada</h3>
                <p class="text-secondary mb-4">Su evaluación ha sido enviada exitosamente</p>
                
                <div class="card" id="resultsCard" style="display: none;">
                    <div class="card-header">
                        <h4 class="card-title">Resultados Preliminares</h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="text-center">
                                    <h2 class="text-primary mb-1" id="scoreDisplay">--</h2>
                                    <p class="text-secondary mb-0">Puntuación Total</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center">
                                    <span class="badge badge-lg" id="recommendationBadge">--</span>
                                    <p class="text-secondary mb-0 mt-2">Recomendación</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3" id="profileDisplay">
                            <strong>Perfil DISC:</strong>
                            <span id="discProfile">--</span>
                        </div>
                        <div class="mt-2" id="detailsDisplay" style="display: none;">
                            <small class="text-secondary">
                                Los resultados detallados serán enviados por correo electrónico
                            </small>
                        </div>
                    </div>
                </div>
                
                <p class="text-secondary mt-4">
                    <strong>¡Gracias por completar la evaluación!</strong><br>
                    Los resultados han sido registrados en nuestro sistema.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Main layout -->
    <div class="page page-center" id="testScreen" style="display: none;">
        <div class="container py-4" style="max-width: 1200px;">
            
            <!-- Logo/Brand -->
            <div class="text-center mb-4">
                <h1 class="h2 text-primary mb-0">Sistema de Evaluación</h1>
                <p class="text-secondary">Anuncios Luminosos</p>
                <div class="text-center mt-2">
                    <small class="text-secondary">
                        Candidato: <strong id="candidateName">--</strong> | 
                        Puesto: <strong id="candidatePosition">--</strong>
                    </small>
                </div>
            </div>
            
            <!-- Main card -->
            <div class="card card-lg">
                <div class="card-body">
                    
                    <!-- Progress indicator -->
                    <div class="section-progress">
                        <div class="progress-step active" id="step1">1</div>
                        <div class="progress-line" id="line1"></div>
                        <div class="progress-step" id="step2">2</div>
                        <div class="progress-line" id="line2"></div>
                        <div class="progress-step" id="step3">3</div>
                        <div class="progress-line" id="line3"></div>
                        <div class="progress-step" id="step4">4</div>
                    </div>
                    
                    <!-- Section 1: CLEAVER -->
                    <div class="section active" id="section1">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Perfil de Comportamiento</h3>
                            <p class="text-secondary">Para cada grupo de palabras, elija la que MÁS y MENOS lo describe</p>
                        </div>
                        
                        <!-- CLEAVER Questions will be generated here -->
                        <div id="cleaverQuestions"></div>
                        
                        <div class="form-footer">
                            <div></div>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section 2: KOSTICK -->
                    <div class="section" id="section2">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Preferencias Laborales</h3>
                            <p class="text-secondary">Indique qué tan de acuerdo está con cada afirmación</p>
                        </div>
                        
                        <div id="kostickQuestions"></div>
                        
                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section 3: Situaciones -->
                    <div class="section" id="section3">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Situaciones Laborales</h3>
                            <p class="text-secondary">¿Cómo actuaría en las siguientes situaciones?</p>
                        </div>
                        
                        <div id="situationsQuestions"></div>
                        
                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section 4: Aptitudes Técnicas -->
                    <div class="section" id="section4">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Aptitudes Técnicas</h3>
                            <p class="text-secondary">Evalúe su experiencia en las siguientes áreas</p>
                        </div>
                        
                        <div id="aptitudesQuestions"></div>
                        
                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-success" onclick="submitForm()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                                Finalizar Evaluación
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center text-secondary mt-3">
                <small>Sistema de Evaluación Psicométrica v2.0</small>
            </div>
            
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // API Configuration
        const API_BASE_URL = '/.netlify/functions';
        
        // Current section tracking
        let currentSection = 1;
        let totalSections = 4;
        let startTime = Date.now();
        
        // Token and candidate info
        let candidateToken = null;
        let candidateInfo = null;
        
        // Test data storage
        let testData = {
            cleaver: {},
            kostick: {},
            situations: {},
            aptitudes: {}
        };
        
        // API utility functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // Extract token from URL
        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }
        
        // Validate token and load candidate info
        async function validateTokenAndLoadCandidate() {
            candidateToken = getTokenFromURL();
            
            if (!candidateToken) {
                showError('Token no encontrado en la URL. Por favor acceda a través del enlace proporcionado por el departamento de recursos humanos.');
                return false;
            }
            
            try {
                const response = await apiCall(`/validate-token?token=${encodeURIComponent(candidateToken)}`);
                candidateInfo = response.candidate;
                
                // Update UI with candidate info
                document.getElementById('candidateName').textContent = candidateInfo.nombre || '--';
                document.getElementById('candidatePosition').textContent = candidateInfo.puesto || '--';
                
                // Load any saved progress
                if (response.respuestasGuardadas) {
                    testData = response.respuestasGuardadas;
                }
                
                return true;
            } catch (error) {
                console.error('Token validation failed:', error);
                showError(error.message || 'Token inválido o expirado');
                return false;
            }
        }
        
        // Show error screen
        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorScreen').style.display = 'block';
        }
        
        // Show test screen
        function showTestScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
        }
        
        // Show success screen with results
        function showSuccessScreen(results = null) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'none';
            
            if (results) {
                // Display results
                document.getElementById('scoreDisplay').textContent = `${results.puntajeTotal}%`;
                document.getElementById('discProfile').textContent = results.perfilDISC || '--';
                
                // Set recommendation badge
                const badge = document.getElementById('recommendationBadge');
                switch (results.recomendacion) {
                    case 'CONTRATAR':
                        badge.className = 'badge badge-lg bg-success';
                        badge.textContent = '✅ CONTRATAR';
                        break;
                    case 'SEGUNDA_ENTREVISTA':
                        badge.className = 'badge badge-lg bg-warning text-dark';
                        badge.textContent = '⚠️ SEGUNDA ENTREVISTA';
                        break;
                    case 'EVALUAR':
                        badge.className = 'badge badge-lg bg-info';
                        badge.textContent = '🤔 EVALUAR';
                        break;
                    case 'RECHAZAR':
                        badge.className = 'badge badge-lg bg-danger';
                        badge.textContent = '❌ RECHAZAR';
                        break;
                    default:
                        badge.className = 'badge badge-lg bg-secondary';
                        badge.textContent = 'PROCESANDO';
                }
                
                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('detailsDisplay').style.display = 'block';
            }
            
            document.getElementById('successScreen').style.display = 'block';
        }
        
        // Auto-save to API
        async function saveToAPI() {
            if (!candidateToken) return false;
            
            try {
                await apiCall('/auto-save', 'POST', {
                    token: candidateToken,
                    respuestas: testData
                });
                return true;
            } catch (error) {
                console.error('API save failed:', error);
                return false;
            }
        }
        
        // CLEAVER questions data
        const CLEAVER_QUESTIONS = [
            { A: "Aventurero", B: "Adaptable", C: "Animoso", D: "Analítico" },
            { A: "Persistente", B: "Juguetón", C: "Persuasivo", D: "Plácido" },
            { A: "Sumiso", B: "Sociable", C: "Fuerte", D: "Seguro de sí mismo" },
            { A: "Considerado", B: "Controlado", C: "Competitivo", D: "Convincente" },
            { A: "Refrescante", B: "Reservado", C: "Recursivo", D: "Respetuoso" },
            { A: "Satisfecho", B: "Sensitivo", C: "Seguro", D: "Sencillo" },
            { A: "Calmado", B: "Confiado", C: "Convencedor", D: "Coherente" },
            { A: "Paciente", B: "Positivo", C: "Promotor", D: "Perfeccionista" }
        ];
        
        // KOSTICK questions
        const KOSTICK_QUESTIONS = [
            "Me gusta trabajar en equipo más que trabajar solo",
            "Prefiero seguir instrucciones claras antes que improvisar",
            "Me motiva más ayudar a otros que obtener reconocimiento personal",
            "Trabajo mejor bajo presión y con plazos ajustados",
            "Prefiero planificar detalladamente antes de actuar", // Crítica
            "Me adapto fácilmente a los cambios en el trabajo",
            "Me gusta asumir responsabilidades de liderazgo",
            "Prefiero trabajos que requieren atención al detalle",
            "Me siento cómodo tomando decisiones rápidas",
            "Disfruto de tareas que requieren creatividad e innovación",
            "Prefiero un ambiente de trabajo estructurado y predecible", // Crítica  
            "Me gusta competir y superar a mis compañeros",
            "Considero más importante la calidad que la velocidad", // Crítica
            "Me motivan los desafíos técnicos complejos",
            "Prefiero trabajar con personas conocidas que con extraños"
        ];
        
        // Situational questions
        const SITUATIONS = [
            {
                scenario: "🚨 Su supervisor le pide que termine un trabajo urgente, pero nota que faltan materiales importantes. El supervisor no está disponible para consultar.",
                options: {
                    A: "Busco materiales alternativos y completo el trabajo lo mejor posible",
                    B: "Espero a que regrese el supervisor para consultarle",
                    C: "Busco a otro supervisor para que me autorice los materiales",
                    D: "Improviso con lo que tengo aunque el resultado no sea el mejor"
                },
                critical: true
            },
            {
                scenario: "Un compañero de trabajo constantemente llega tarde y usted tiene que cubrir su trabajo extra.",
                options: {
                    A: "Hablo directamente con el compañero sobre el problema",
                    B: "Reporto la situación a mi supervisor inmediatamente",
                    C: "Continúo cubriendo sin decir nada para mantener la armonía",
                    D: "Busco una solución que beneficie al equipo completo"
                },
                critical: false
            },
            {
                scenario: "Encuentra un error importante en el trabajo de un compañero que ya fue entregado al cliente.",
                options: {
                    A: "Informo inmediatamente a mi supervisor sobre el error",
                    B: "Hablo primero con el compañero para que corrija su error",
                    C: "Corrijo discretamente el error sin mencionarlo",
                    D: "Documento el error pero no tomo acción inmediata"
                },
                critical: false
            },
            {
                scenario: "🚨 Le ofrecen un soborno para aprobar un trabajo que no cumple con los estándares de calidad.",
                options: {
                    A: "Rechazo el soborno y reporto el incidente inmediatamente",
                    B: "Rechazo el soborno pero no reporto para evitar problemas",
                    C: "Acepto el dinero pero me aseguro de que el trabajo se corrija",
                    D: "Acepto el dinero y apruebo el trabajo para evitar conflictos"
                },
                critical: true
            }
        ];
        
        // Technical aptitudes
        const APTITUDES = [
            "Soldadura con electrodo",
            "Instalaciones eléctricas básicas",
            "Manejo de herramientas eléctricas",
            "Lectura de planos técnicos",
            "Trabajo en alturas",
            "Instalación de letreros luminosos",
            "Mantenimiento preventivo",
            "Trabajo con tubos de neón/LED"
        ];
        
        // Initialize form
        async function initializeForm() {
            // First validate token and load candidate info
            const isValid = await validateTokenAndLoadCandidate();
            
            if (!isValid) {
                return; // Error screen will be shown
            }
            
            // Generate all questions
            generateCleaverQuestions();
            generateKostickQuestions();
            generateSituationsQuestions();
            generateAptitudesQuestions();
            
            // Restore UI state if we have saved data
            if (testData && Object.keys(testData).length > 0) {
                restoreUIState();
            }
            
            // Start auto-save
            startAutoSave();
            
            // Show the test screen
            showTestScreen();
        }
        
        // Generate CLEAVER questions
        function generateCleaverQuestions() {
            const container = document.getElementById('cleaverQuestions');
            
            CLEAVER_QUESTIONS.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Pregunta ${index + 1}</span>
                    </div>
                    <div class="question-body">
                        <div class="cleaver-words">
                            <div class="word-card" data-option="A" data-question="${index}">
                                <div class="word-letter">A</div>
                                <div class="word-text">${question.A}</div>
                            </div>
                            <div class="word-card" data-option="B" data-question="${index}">
                                <div class="word-letter">B</div>
                                <div class="word-text">${question.B}</div>
                            </div>
                            <div class="word-card" data-option="C" data-question="${index}">
                                <div class="word-letter">C</div>
                                <div class="word-text">${question.C}</div>
                            </div>
                            <div class="word-card" data-option="D" data-question="${index}">
                                <div class="word-letter">D</div>
                                <div class="word-text">${question.D}</div>
                            </div>
                        </div>
                        
                        <div class="choice-section">
                            <div class="choice-grid">
                                <div class="choice-column">
                                    <div class="choice-label mas">
                                        🔵 MÁS describe
                                    </div>
                                    <div class="choice-buttons">
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="A">A</button>
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="B">B</button>
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="C">C</button>
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="D">D</button>
                                    </div>
                                </div>
                                
                                <div class="choice-separator"></div>
                                
                                <div class="choice-column">
                                    <div class="choice-label menos">
                                        🔴 MENOS describe
                                    </div>
                                    <div class="choice-buttons">
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="A">A</button>
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="B">B</button>
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="C">C</button>
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="D">D</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
            
            // Add event listeners for CLEAVER choices
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', handleCleaverChoice);
            });
        }
        
        // Handle CLEAVER choice selection
        function handleCleaverChoice(event) {
            const button = event.target;
            const type = button.dataset.type;
            const question = parseInt(button.dataset.question);
            const option = button.dataset.option;
            
            // Remove selection from other buttons in the same group
            document.querySelectorAll(`[data-type="${type}"][data-question="${question}"]`)
                .forEach(btn => btn.classList.remove('selected'));
            
            // Add selection to clicked button
            button.classList.add('selected');
            
            // Save choice
            if (!testData.cleaver[question]) {
                testData.cleaver[question] = {};
            }
            testData.cleaver[question][type] = option;
            
            // Update word card styling
            updateCleaverWordCards(question);
            
            // Auto-save
            saveData();
        }
        
        // Update word card visual feedback
        function updateCleaverWordCards(questionIndex) {
            const questionData = testData.cleaver[questionIndex];
            if (!questionData) return;
            
            // Reset all cards for this question
            document.querySelectorAll(`[data-question="${questionIndex}"].word-card`)
                .forEach(card => {
                    card.classList.remove('selected-mas', 'selected-menos', 'selected-both');
                });
            
            // Apply styling based on selections
            if (questionData.mas) {
                const masCard = document.querySelector(`[data-question="${questionIndex}"][data-option="${questionData.mas}"].word-card`);
                if (masCard) masCard.classList.add('selected-mas');
            }
            
            if (questionData.menos) {
                const menosCard = document.querySelector(`[data-question="${questionIndex}"][data-option="${questionData.menos}"].word-card`);
                if (menosCard) menosCard.classList.add('selected-menos');
            }
            
            // Check for same selection (warning)
            if (questionData.mas === questionData.menos && questionData.mas) {
                const bothCard = document.querySelector(`[data-question="${questionIndex}"][data-option="${questionData.mas}"].word-card`);
                if (bothCard) {
                    bothCard.classList.remove('selected-mas', 'selected-menos');
                    bothCard.classList.add('selected-both');
                }
            }
        }
        
        // Generate KOSTICK questions
        function generateKostickQuestions() {
            const container = document.getElementById('kostickQuestions');
            
            KOSTICK_QUESTIONS.forEach((question, index) => {
                const isCritical = [4, 10, 12].includes(index);
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                if (isCritical) {
                    questionCard.style.borderLeft = '4px solid var(--warning-color)';
                }
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Pregunta ${index + 1}</span>
                        ${isCritical ? '<span class="badge bg-warning text-dark ms-2">⚠️ Importante</span>' : ''}
                    </div>
                    <div class="question-body">
                        <p class="mb-3">${question}</p>
                        
                        <div class="row g-2">
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="TD" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'TD')">
                                    <span class="form-selectgroup-label">
                                        <strong>TD</strong><br>
                                        <small>Totalmente en Desacuerdo</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="D" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'D')">
                                    <span class="form-selectgroup-label">
                                        <strong>D</strong><br>
                                        <small>En Desacuerdo</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="N" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'N')">
                                    <span class="form-selectgroup-label">
                                        <strong>N</strong><br>
                                        <small>Neutral</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="A" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'A')">
                                    <span class="form-selectgroup-label">
                                        <strong>A</strong><br>
                                        <small>De Acuerdo</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="TA" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'TA')">
                                    <span class="form-selectgroup-label">
                                        <strong>TA</strong><br>
                                        <small>Totalmente de Acuerdo</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
        }
        
        // Generate situational questions
        function generateSituationsQuestions() {
            const container = document.getElementById('situationsQuestions');
            
            SITUATIONS.forEach((situation, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                if (situation.critical) {
                    questionCard.style.borderLeft = '4px solid var(--danger-color)';
                }
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Situación ${index + 1}</span>
                        ${situation.critical ? '<span class="badge bg-danger ms-2">🚨 Crítica</span>' : ''}
                    </div>
                    <div class="question-body">
                        <div class="alert alert-info mb-3">
                            ${situation.scenario}
                        </div>
                        
                        <p class="fw-bold mb-3">¿Qué haría?</p>
                        
                        <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="A" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'A')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>A)</strong> ${situation.options.A}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="B" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'B')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>B)</strong> ${situation.options.B}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="C" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'C')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>C)</strong> ${situation.options.C}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="D" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'D')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>D)</strong> ${situation.options.D}
                                    </span>
                                </span>
                            </label>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
        }
        
        // Generate aptitudes questions
        function generateAptitudesQuestions() {
            const container = document.getElementById('aptitudesQuestions');
            
            APTITUDES.forEach((aptitude, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Aptitud ${index + 1}</span>
                    </div>
                    <div class="question-body">
                        <p class="mb-3"><strong>${aptitude}</strong></p>
                        <p class="text-secondary mb-3">¿Cuál es su nivel de experiencia en esta área?</p>
                        
                        <div class="row g-2">
                            <div class="col-6 col-md">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="aptitud_${index}" value="0" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, '0')">
                                    <span class="form-selectgroup-label">
                                        <strong>Sin experiencia</strong><br>
                                        <small class="text-secondary">Nunca lo he hecho</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col-6 col-md">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="aptitud_${index}" value="1" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, '1')">
                                    <span class="form-selectgroup-label">
                                        <strong>Básico</strong><br>
                                        <small class="text-secondary">He observado o ayudado</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col-6 col-md">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="aptitud_${index}" value="2" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, '2')">
                                    <span class="form-selectgroup-label">
                                        <strong>Intermedio</strong><br>
                                        <small class="text-secondary">Puedo hacerlo con supervisión</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col-6 col-md">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="aptitud_${index}" value="3" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, '3')">
                                    <span class="form-selectgroup-label">
                                        <strong>Avanzado</strong><br>
                                        <small class="text-secondary">Trabajo independientemente</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col-6 col-md">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="aptitud_${index}" value="4" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, '4')">
                                    <span class="form-selectgroup-label">
                                        <strong>Experto</strong><br>
                                        <small class="text-secondary">Puedo enseñar a otros</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
        }
        
        // Handle choice updates
        function updateKostickChoice(questionIndex, value) {
            testData.kostick[questionIndex] = value;
            saveData();
        }
        
        function updateSituationChoice(questionIndex, value) {
            testData.situations[questionIndex] = value;
            saveData();
        }
        
        function updateAptitudeChoice(questionIndex, value) {
            testData.aptitudes[questionIndex] = value;
            saveData();
        }
        
        // Navigation functions
        function nextSection() {
            if (currentSection < totalSections) {
                // Validate current section before proceeding
                if (!validateCurrentSection()) {
                    return;
                }
                
                // Hide current section
                document.getElementById(`section${currentSection}`).classList.remove('active');
                
                // Update progress
                document.getElementById(`step${currentSection}`).classList.remove('active');
                document.getElementById(`step${currentSection}`).classList.add('completed');
                if (currentSection < totalSections) {
                    document.getElementById(`line${currentSection}`).classList.add('completed');
                }
                
                // Show next section
                currentSection++;
                document.getElementById(`section${currentSection}`).classList.add('active');
                document.getElementById(`step${currentSection}`).classList.add('active');
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        // Validate current section
        function validateCurrentSection() {
            switch (currentSection) {
                case 1: // CLEAVER
                    return validateCleaverSection();
                case 2: // KOSTICK
                    return validateKostickSection();
                case 3: // SITUATIONS
                    return validateSituationsSection();
                case 4: // APTITUDES
                    return validateAptitudesSection();
                default:
                    return true;
            }
        }
        
        function validateCleaverSection() {
            const totalQuestions = CLEAVER_QUESTIONS.length;
            const completedQuestions = Object.keys(testData.cleaver || {}).filter(questionIndex => {
                const questionData = testData.cleaver[questionIndex];
                return questionData && questionData.mas && questionData.menos;
            }).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las preguntas. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function validateKostickSection() {
            const totalQuestions = KOSTICK_QUESTIONS.length;
            const completedQuestions = Object.keys(testData.kostick || {}).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las preguntas. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function validateSituationsSection() {
            const totalQuestions = SITUATIONS.length;
            const completedQuestions = Object.keys(testData.situations || {}).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las situaciones. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function validateAptitudesSection() {
            const totalQuestions = APTITUDES.length;
            const completedQuestions = Object.keys(testData.aptitudes || {}).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las aptitudes. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function prevSection() {
            if (currentSection > 1) {
                // Hide current section
                document.getElementById(`section${currentSection}`).classList.remove('active');
                document.getElementById(`step${currentSection}`).classList.remove('active');
                
                // Update progress
                currentSection--;
                document.getElementById(`step${currentSection}`).classList.remove('completed');
                document.getElementById(`step${currentSection}`).classList.add('active');
                if (currentSection < totalSections) {
                    document.getElementById(`line${currentSection}`).classList.remove('completed');
                }
                
                // Show previous section
                document.getElementById(`section${currentSection}`).classList.add('active');
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        // Auto-save functionality
        function startAutoSave() {
            setInterval(saveData, 30000); // Save every 30 seconds
        }
        
        async function saveData() {
            let saveSuccess = false;
            
            // Show saving indicator
            showSaveIndicator(true);
            
            // Always save to localStorage as backup
            try {
                localStorage.setItem('evaluacion_psicometrica', JSON.stringify(testData));
                saveSuccess = true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
            
            // Try to save to API
            if (candidateToken && navigator.onLine) {
                try {
                    await saveToAPI();
                    saveSuccess = true;
                } catch (error) {
                    console.error('Error saving to API:', error);
                    // Don't show error to user, localStorage backup is available
                }
            }
            
            if (saveSuccess) {
                showSaveIndicator(false);
            } else {
                // Hide saving indicator if failed
                document.getElementById('saveIndicator').style.display = 'none';
            }
        }
        
        function loadSavedData() {
            // This function is now handled in validateTokenAndLoadCandidate
            // keeping for backward compatibility
            try {
                const saved = localStorage.getItem('evaluacion_psicometrica');
                if (saved && (!testData || Object.keys(testData).length === 0)) {
                    testData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading localStorage data:', error);
            }
        }
        
        function restoreUIState() {
            // Restore CLEAVER selections
            Object.keys(testData.cleaver || {}).forEach(questionIndex => {
                const questionData = testData.cleaver[questionIndex];
                
                if (questionData.mas) {
                    const masBtn = document.querySelector(`[data-type="mas"][data-question="${questionIndex}"][data-option="${questionData.mas}"]`);
                    if (masBtn) masBtn.classList.add('selected');
                }
                
                if (questionData.menos) {
                    const menosBtn = document.querySelector(`[data-type="menos"][data-question="${questionIndex}"][data-option="${questionData.menos}"]`);
                    if (menosBtn) menosBtn.classList.add('selected');
                }
                
                updateCleaverWordCards(parseInt(questionIndex));
            });
            
            // Restore KOSTICK selections
            Object.keys(testData.kostick || {}).forEach(questionIndex => {
                const value = testData.kostick[questionIndex];
                const radio = document.querySelector(`input[name="kostick_${questionIndex}"][value="${value}"]`);
                if (radio) radio.checked = true;
            });
            
            // Restore SITUATIONS selections
            Object.keys(testData.situations || {}).forEach(questionIndex => {
                const value = testData.situations[questionIndex];
                const radio = document.querySelector(`input[name="situation_${questionIndex}"][value="${value}"]`);
                if (radio) radio.checked = true;
            });
            
            // Restore APTITUDES selections
            Object.keys(testData.aptitudes || {}).forEach(questionIndex => {
                const value = testData.aptitudes[questionIndex];
                const radio = document.querySelector(`input[name="aptitud_${questionIndex}"][value="${value}"]`);
                if (radio) radio.checked = true;
            });
        }
        
        function showSaveIndicator(saving = false) {
            const indicator = document.getElementById('saveIndicator');
            
            if (saving) {
                indicator.innerHTML = '💾 Guardando...';
                indicator.style.background = 'var(--primary-color)';
                indicator.style.display = 'block';
            } else {
                indicator.innerHTML = '✓ Guardado automáticamente';
                indicator.style.background = 'var(--success-color)';
                indicator.style.display = 'block';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        async function submitForm() {
            // Final validation
            if (!validateCurrentSection()) {
                return;
            }
            
            // Show completion confirmation
            const confirmSubmit = confirm('¿Está seguro de que desea finalizar la evaluación? No podrá hacer cambios después de enviarla.');
            
            if (!confirmSubmit) {
                return;
            }
            
            // Calculate total time spent
            const tiempoTotal = Math.round((Date.now() - startTime) / 1000); // in seconds
            
            // Prepare personal data
            const datosPersonales = {
                nombre: candidateInfo?.nombre || 'No especificado',
                email: candidateInfo?.email || '',
                puesto: candidateInfo?.puesto || 'No especificado',
                fechaEvaluacion: new Date().toISOString()
            };
            
            // Show loading state
            const submitBtn = document.querySelector('[onclick="submitForm()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Enviando...
            `;
            
            try {
                // Submit to API
                const response = await apiCall('/submit-test', 'POST', {
                    token: candidateToken,
                    respuestas: testData,
                    datosPersonales: datosPersonales,
                    tiempoTotal: tiempoTotal
                });
                
                // Save final submission to localStorage as backup
                const submissionData = {
                    timestamp: new Date().toISOString(),
                    cleaver: testData.cleaver,
                    kostick: testData.kostick,
                    situations: testData.situations,
                    aptitudes: testData.aptitudes,
                    datosPersonales: datosPersonales,
                    tiempoTotal: tiempoTotal,
                    metadata: {
                        userAgent: navigator.userAgent,
                        screenResolution: `${screen.width}x${screen.height}`,
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    results: response.results || null
                };
                
                localStorage.setItem('evaluacion_psicometrica_final', JSON.stringify(submissionData));
                
                // Show success screen with results
                showSuccessScreen(response.results);
                
            } catch (error) {
                console.error('Submission failed:', error);
                
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                // Show error but offer offline backup
                const retrySubmit = confirm(
                    `❌ Error al enviar la evaluación: ${error.message}\n\n` +
                    `¿Desea intentar nuevamente?\n\n` +
                    `• Sí: Intentar envío nuevamente\n` +
                    `• No: Guardar localmente y contactar soporte`
                );
                
                if (retrySubmit) {
                    // Retry submission
                    submitForm();
                } else {
                    // Save locally and show instructions
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        token: candidateToken,
                        respuestas: testData,
                        datosPersonales: datosPersonales,
                        tiempoTotal: tiempoTotal,
                        error: error.message
                    };
                    
                    localStorage.setItem('evaluacion_psicometrica_backup', JSON.stringify(backupData));
                    
                    alert(
                        `💾 Sus respuestas han sido guardadas localmente.\n\n` +
                        `Por favor contacte a soporte técnico con el siguiente código:\n` +
                        `ERROR-${Date.now()}\n\n` +
                        `📧 Correo: rrhh@anunciosluminosos.com\n` +
                        `📞 Teléfono: [NÚMERO DE SOPORTE]`
                    );
                }
            }
        }
        
        // Network monitoring
        function monitorNetworkStatus() {
            const networkIndicator = document.getElementById('networkIndicator');
            
            function updateNetworkStatus() {
                if (!navigator.onLine) {
                    networkIndicator.style.display = 'block';
                } else {
                    networkIndicator.style.display = 'none';
                }
            }
            
            // Check initial status
            updateNetworkStatus();
            
            // Listen for network changes
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            monitorNetworkStatus();
            initializeForm();
        });
    </script>
</body>
</html>