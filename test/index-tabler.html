<!doctype html>
<!--
* Evaluación Psicométrica - Sistema de Contratación
* Basado en Tabler Framework - Template Wizard
-->
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Evaluación Psicométrica - Anuncios Luminosos</title>
    
    <!-- Tabler CSS -->
    <link href="../admin/dist/css/tabler.css" rel="stylesheet" />
    <link href="../admin/dist/css/theme-custom.css" rel="stylesheet" />
    
    <style>
        @import url('https://rsms.me/inter/inter.css');
        
        /* Variables personalizadas */
        :root {
            --primary-color: #066fd1;
            --success-color: #2fb344;
            --danger-color: #dc3545;
            --warning-color: #ffc107;

            /* Light theme colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border-color: #dee2e6;
            --border-light: #e6e6e6;
            --card-bg: #ffffff;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --button-bg: #f8f9fa;
            --signature-bg: #f8f9fa;
            --signature-border: #ccc;
        }

        /* Dark theme colors */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
            --border-color: #404040;
            --border-light: #555555;
            --card-bg: #2d2d2d;
            --card-shadow: rgba(0, 0, 0, 0.3);
            --input-bg: #404040;
            --button-bg: #404040;
            --signature-bg: #404040;
            --signature-border: #666666;
        }
        
        /* Global theme styles */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px var(--card-shadow);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Auto-save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px var(--card-shadow);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        /* Loading states */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Results card animations */
        .card {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Badge improvements */
        .badge-lg {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
        }
        
        /* Section progress */
        .section-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 2rem;
        }
        
        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border: 2px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .progress-step.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .progress-step.completed {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .progress-line {
            width: 60px;
            height: 2px;
            background: var(--border-light);
            transition: background 0.3s;
        }

        .progress-line.completed {
            background: var(--success-color);
        }
        
        /* Question styles */
        .question-card {
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            overflow: hidden;
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        .question-header {
            background: var(--bg-secondary);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .question-number {
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        .question-body {
            padding: 1.5rem;
            background: var(--card-bg);
        }
        
        /* CLEAVER specific styles */
        .cleaver-words {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .word-card {
            text-align: center;
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 0.5rem;
            background: var(--bg-secondary);
            transition: all 0.3s;
        }
        
        .word-card.selected-mas {
            border-color: var(--primary-color);
            background: rgba(6, 111, 209, 0.1);
        }
        
        .word-card.selected-menos {
            border-color: var(--danger-color);
            background: rgba(220, 53, 69, 0.1);
        }
        
        .word-card.selected-both {
            border-color: var(--warning-color);
            background: rgba(255, 193, 7, 0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .word-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 0.5rem;
        }
        
        .word-text {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Choice section */
        .choice-section {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: start;
            width: 100%;
            min-height: 120px;
        }
        
        .choice-column {
            text-align: center;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        .choice-column:first-child {
            justify-self: center;
        }
        
        .choice-column:last-child {
            justify-self: center;
        }
        
        .choice-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
        }
        
        .choice-label.mas {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
        }
        
        .choice-label.menos {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
            color: white;
        }
        
        .choice-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .choice-btn {
            width: 45px;
            height: 45px;
            border: 2px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--input-bg);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .choice-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .choice-btn.selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }
        
        .choice-column:last-child .choice-btn.selected {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .choice-separator {
            width: 2px;
            height: 80px;
            background: linear-gradient(to bottom, var(--border-color), var(--text-muted), var(--border-color));
            border-radius: 1px;
        }
        
        /* Navigation buttons */
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* Desktop styles - default */
        @media (min-width: 769px) {
            .container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
            
            .choice-grid {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 3rem;
                align-items: start;
            }
            
            .choice-separator {
                width: 3px;
                height: 100px;
                background: linear-gradient(to bottom, var(--border-color), var(--text-muted), var(--border-color));
            }
            
            .cleaver-words {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
            
            .choice-btn {
                width: 50px;
                height: 50px;
                font-size: 16px;
            }
            
            .choice-buttons {
                gap: 1rem;
            }
        }
        
        /* Tablet responsive */
        @media (max-width: 768px) and (min-width: 481px) {
            .container {
                padding: 1rem;
            }
            
            .choice-grid {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 2rem;
                align-items: start;
            }
            
            .choice-separator {
                width: 2px;
                height: 80px;
            }
            
            .cleaver-words {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .choice-buttons {
                gap: 0.75rem;
            }
            
            .choice-btn {
                width: 45px;
                height: 45px;
            }
        }
        
        /* Mobile responsive */
        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }

            /* Adjust theme toggle for mobile */
            .theme-toggle {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .choice-grid {
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
            }
            
            .choice-separator {
                width: 80px;
                height: 2px;
                align-self: center;
                margin: 0 auto;
            }
            
            .cleaver-words {
                grid-template-columns: 1fr;
            }
            
            .choice-buttons {
                gap: 0.5rem;
            }
            
            .choice-btn {
                width: 45px;
                height: 45px;
            }
            
            .form-footer {
                flex-direction: column;
                gap: 1rem;
            }
            
            .form-footer .btn {
                width: 100%;
            }
            
            .choice-label {
                font-size: 14px;
                padding: 0.375rem 0.75rem;
            }
        }
        
        /* Card styling improvements */
        .card-lg {
            box-shadow: 0 0.5rem 1rem var(--card-shadow);
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .card-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .card-body {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        /* Alert styles for dark mode */
        .alert {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .alert-info {
            background: rgba(13, 202, 240, 0.1);
            border-color: rgba(13, 202, 240, 0.2);
            color: var(--text-primary);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.2);
            color: var(--text-primary);
        }

        .alert-light {
            background: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        /* Form controls dark mode */
        .form-check-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .form-check-label {
            color: var(--text-primary);
        }

        .form-selectgroup-label {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .form-selectgroup-input:checked + .form-selectgroup-label {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Signature pad dark mode */
        #signaturePad {
            background: var(--signature-bg) !important;
            border: 2px dashed var(--signature-border) !important;
            border-radius: 8px;
        }

        /* Text colors */
        .text-secondary {
            color: var(--text-secondary) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .text-primary {
            color: var(--text-primary) !important;
        }

        /* Badge improvements for dark mode */
        .badge {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Spinner improvements */
        .spinner-border {
            color: var(--primary-color);
        }

        /* Page screens dark mode support */
        .page {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .page-center {
            background: var(--bg-primary);
        }

        /* Icons and SVG elements */
        .icon {
            color: inherit;
        }

        /* Small text elements */
        small {
            color: var(--text-muted) !important;
        }

        /* Links */
        a {
            color: var(--primary-color);
        }

        a:hover {
            color: var(--primary-color);
            opacity: 0.8;
        }
        
        /* Hidden sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Theme toggle button -->
    <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Cambiar tema">
        <span id="themeIcon">☀️</span>
    </div>

    <!-- Auto-save indicator -->
    <div class="save-indicator" id="saveIndicator">
        ✓ Guardado automáticamente
    </div>

    <!-- Network status indicator -->
    <div class="save-indicator" id="networkIndicator" style="background: var(--warning-color); color: #000; display: none; right: 20px; top: 60px;">
        ⚠️ Sin conexión - Guardando localmente
    </div>
    
    <!-- Loading screen -->
    <div class="page page-center" id="loadingScreen">
        <div class="container py-4">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h3>Verificando credenciales...</h3>
                <p class="text-secondary">Por favor espere mientras validamos su token de acceso</p>
            </div>
        </div>
    </div>
    
    <!-- Error screen -->
    <div class="page page-center" id="errorScreen" style="display: none;">
        <div class="container py-4">
            <div class="text-center">
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-danger" width="64" height="64" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                        <circle cx="12" cy="12" r="9"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                </div>
                <h3 class="text-danger">Error de Acceso</h3>
                <p class="text-secondary mb-3" id="errorMessage">Token inválido o expirado</p>
                <div class="alert alert-warning">
                    <strong>¿Qué hacer?</strong><br>
                    • Verifique que el enlace sea correcto<br>
                    • Solicite un nuevo enlace a su supervisor<br>
                    • Contacte al departamento de recursos humanos
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success screen -->
    <div class="page page-center" id="successScreen" style="display: none;">
        <div class="container py-4">
            <div class="text-center">
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-success" width="64" height="64" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                        <circle cx="12" cy="12" r="9"/>
                        <path d="m9 12l2 2l4 -4"/>
                    </svg>
                </div>
                <h3 class="text-success">Evaluación Completada</h3>
                <p class="text-secondary mb-4">Su evaluación ha sido enviada exitosamente</p>
                
                <div class="card" id="resultsCard" style="display: none;">
                    <div class="card-header">
                        <h4 class="card-title">Resultados Preliminares</h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="text-center">
                                    <h2 class="text-primary mb-1" id="scoreDisplay">--</h2>
                                    <p class="text-secondary mb-0">Puntuación Total</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center">
                                    <span class="badge badge-lg" id="recommendationBadge">--</span>
                                    <p class="text-secondary mb-0 mt-2">Recomendación</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3" id="profileDisplay">
                            <strong>Perfil DISC:</strong>
                            <span id="discProfile">--</span>
                        </div>
                        <div class="mt-2" id="detailsDisplay" style="display: none;">
                            <small class="text-secondary">
                                Los resultados detallados serán enviados por correo electrónico
                            </small>
                        </div>
                    </div>
                </div>
                
                <p class="text-secondary mt-4">
                    <strong>¡Gracias por completar la evaluación!</strong><br>
                    Los resultados han sido registrados en nuestro sistema.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Main layout -->
    <div class="page page-center" id="testScreen" style="display: none;">
        <div class="container py-4" style="max-width: 1200px;">
            
            <!-- Logo/Brand -->
            <div class="text-center mb-4">
                <h1 class="h2 text-primary mb-0">Sistema de Evaluación</h1>
                <p class="text-secondary">Anuncios Luminosos</p>
                <div class="text-center mt-2">
                    <small class="text-secondary">
                        Candidato: <strong id="candidateName">--</strong> | 
                        Puesto: <strong id="candidatePosition">--</strong>
                    </small>
                </div>
            </div>
            
            <!-- Main card -->
            <div class="card card-lg">
                <div class="card-body">
                    
                    <!-- Progress indicator -->
                    <div class="section-progress">
                        <div class="progress-step active" id="step1">1</div>
                        <div class="progress-line" id="line1"></div>
                        <div class="progress-step" id="step2">2</div>
                        <div class="progress-line" id="line2"></div>
                        <div class="progress-step" id="step3">3</div>
                        <div class="progress-line" id="line3"></div>
                        <div class="progress-step" id="step4">4</div>
                    </div>
                    
                    <!-- Section 1: CLEAVER -->
                    <div class="section active" id="section1">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Perfil de Comportamiento</h3>
                            <p class="text-secondary">Para cada grupo de palabras, elija la que MÁS y MENOS lo describe</p>
                        </div>
                        
                        <!-- CLEAVER Questions will be generated here -->
                        <div id="cleaverQuestions"></div>
                        
                        <div class="form-footer">
                            <div></div>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section 2: KOSTICK -->
                    <div class="section" id="section2">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Preferencias Laborales</h3>
                            <p class="text-secondary">Indique qué tan de acuerdo está con cada afirmación</p>
                        </div>
                        
                        <div id="kostickQuestions"></div>
                        
                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section 3: Situaciones -->
                    <div class="section" id="section3">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Situaciones Laborales</h3>
                            <p class="text-secondary">¿Cómo actuaría en las siguientes situaciones?</p>
                        </div>
                        
                        <div id="situationsQuestions"></div>
                        
                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section 4: Aptitudes Técnicas -->
                    <div class="section" id="section4">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Aptitudes Técnicas</h3>
                            <p class="text-secondary">Evalúe su experiencia en las siguientes áreas</p>
                        </div>
                        
                        <div id="aptitudesQuestions"></div>
                        
                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextSection()">
                                Continuar
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Section 5: Declaración y Firma -->
                    <div class="section" id="section5">
                        <div class="text-center mb-4">
                            <h3 class="h4 mb-1">Declaración y Firma Digital</h3>
                            <p class="text-secondary">Confirmación final y firma de la evaluación</p>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h4 class="card-title mb-3">🛡️ Declaración de Veracidad</h4>

                                        <div class="alert alert-info">
                                            <div class="d-flex">
                                                <div>
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                                        <circle cx="12" cy="12" r="9"/>
                                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    Al completar esta evaluación, usted declara bajo juramento que:
                                                </div>
                                            </div>
                                        </div>

                                        <div class="declaration-list mb-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="declaration1" required>
                                                <label class="form-check-label" for="declaration1">
                                                    <strong>📝 Veracidad:</strong> Todas las respuestas proporcionadas son verdaderas y reflejan fielmente mi experiencia, conocimientos y forma de actuar.
                                                </label>
                                            </div>

                                            <div class="form-check mt-3">
                                                <input class="form-check-input" type="checkbox" id="declaration2" required>
                                                <label class="form-check-label" for="declaration2">
                                                    <strong>🤝 Integridad:</strong> He respondido de manera honesta sin consultar fuentes externas o recibir ayuda de terceros durante la evaluación.
                                                </label>
                                            </div>

                                            <div class="form-check mt-3">
                                                <input class="form-check-input" type="checkbox" id="declaration3" required>
                                                <label class="form-check-label" for="declaration3">
                                                    <strong>📋 Consentimiento:</strong> Autorizo el uso de esta información para fines de evaluación laboral y entiendo que será tratada de manera confidencial.
                                                </label>
                                            </div>

                                            <div class="form-check mt-3">
                                                <input class="form-check-input" type="checkbox" id="declaration4" required>
                                                <label class="form-check-label" for="declaration4">
                                                    <strong>⚖️ Responsabilidad:</strong> Comprendo que proporcionar información falsa puede resultar en la descalificación del proceso de selección.
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="signature-section">
                                            <h5 class="mb-3">✍️ Firma Digital</h5>
                                            <div class="signature-pad-container">
                                                <canvas id="signaturePad" width="300" height="150" style="border: 2px dashed #ccc; border-radius: 8px; background: #f8f9fa;"></canvas>
                                            </div>

                                            <div class="signature-info mt-3">
                                                <p class="text-muted small mb-2">
                                                    <strong>Candidato:</strong> <span id="candidateNameSignature">--</span><br>
                                                    <strong>Fecha:</strong> <span id="currentDate">--</span><br>
                                                    <strong>Hora:</strong> <span id="currentTime">--</span>
                                                </p>
                                            </div>

                                            <div class="signature-actions">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSignature()">
                                                    🗑️ Limpiar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-footer">
                            <button type="button" class="btn btn-secondary" onclick="prevSection()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M5 18l6 -6"/>
                                    <path d="M5 6l6 6"/>
                                </svg>
                                Anterior
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="submitForm()" id="finalSubmitBtn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="m0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l14 0"/>
                                    <path d="M13 18l6 -6"/>
                                    <path d="M13 6l6 6"/>
                                </svg>
                                🏁 Finalizar Evaluación
                            </button>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center text-secondary mt-3">
                <small>Sistema de Evaluación Psicométrica v2.0</small>
            </div>
            
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // Theme Management System
        function initializeTheme() {
            // Check for saved theme preference or default to light mode
            const savedTheme = localStorage.getItem('psychometric-test-theme') || 'light';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            // Apply theme to document
            document.documentElement.setAttribute('data-theme', theme);

            // Update theme toggle icon
            updateThemeToggleIcon(theme);

            // Save theme preference
            localStorage.setItem('psychometric-test-theme', theme);

            // Update signature pad background if it exists
            updateSignaturePadTheme(theme);
        }

        function updateThemeToggleIcon(theme) {
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                if (theme === 'dark') {
                    themeIcon.textContent = '🌙';
                    themeIcon.setAttribute('title', 'Cambiar a modo claro');
                } else {
                    themeIcon.textContent = '☀️';
                    themeIcon.setAttribute('title', 'Cambiar a modo oscuro');
                }
            }
        }

        function updateSignaturePadTheme(theme) {
            const signaturePad = document.getElementById('signaturePad');
            if (signaturePad) {
                const ctx = signaturePad.getContext('2d');
                if (theme === 'dark') {
                    ctx.strokeStyle = '#ffffff';
                } else {
                    ctx.strokeStyle = '#000000';
                }

                // Update existing signature if present
                if (testData.signature) {
                    // Redraw signature with new stroke color
                    redrawSignatureWithTheme(ctx, theme);
                }
            }
        }

        function redrawSignatureWithTheme(ctx, theme) {
            // This function would redraw the signature with the correct color
            // For now, we'll just ensure new strokes use the correct color
            // The signature data would need to be reprocessed to change existing strokes
        }

        // Theme persistence across navigation
        function persistThemeAcrossSections() {
            // This ensures theme persists when navigating between sections
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            localStorage.setItem('psychometric-test-theme', currentTheme);
        }

        // API Configuration
        const API_BASE_URL = '/.netlify/functions';
        
        // Current section tracking
        let currentSection = 1;
        let totalSections = 5;
        let startTime = Date.now();
        
        // Token and candidate info
        let candidateToken = null;
        let candidateInfo = null;
        
        // Test data storage
        let testData = {
            cleaver: {},
            kostick: {},
            situations: {},
            aptitudes: {},
            declaration: {},
            signature: null
        };

        // Signature pad variables
        let signaturePad = null;
        let isDrawing = false;
        
        // API utility functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        // Extract token from URL
        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }
        
        // Validate token and load candidate info
        async function validateTokenAndLoadCandidate() {
            candidateToken = getTokenFromURL();
            
            if (!candidateToken) {
                showError('Token no encontrado en la URL. Por favor acceda a través del enlace proporcionado por el departamento de recursos humanos.');
                return false;
            }
            
            try {
                const response = await apiCall(`/validate-token?token=${encodeURIComponent(candidateToken)}`);
                candidateInfo = response.candidate;
                
                // Update UI with candidate info
                document.getElementById('candidateName').textContent = candidateInfo.nombre || '--';
                document.getElementById('candidatePosition').textContent = candidateInfo.puesto || '--';
                
                // Load any saved progress
                if (response.respuestasGuardadas) {
                    testData = response.respuestasGuardadas;
                }
                
                return true;
            } catch (error) {
                console.error('Token validation failed:', error);
                showError(error.message || 'Token inválido o expirado');
                return false;
            }
        }
        
        // Show error screen
        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorScreen').style.display = 'block';
        }
        
        // Show test screen
        function showTestScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
        }
        
        // Show success screen with results
        function showSuccessScreen(results = null) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'none';
            
            if (results) {
                // Display results
                document.getElementById('scoreDisplay').textContent = `${results.puntajeTotal}%`;
                document.getElementById('discProfile').textContent = results.perfilDISC || '--';
                
                // Set recommendation badge
                const badge = document.getElementById('recommendationBadge');
                switch (results.recomendacion) {
                    case 'CONTRATAR':
                        badge.className = 'badge badge-lg bg-success';
                        badge.textContent = '✅ CONTRATAR';
                        break;
                    case 'SEGUNDA_ENTREVISTA':
                        badge.className = 'badge badge-lg bg-warning text-dark';
                        badge.textContent = '⚠️ SEGUNDA ENTREVISTA';
                        break;
                    case 'EVALUAR':
                        badge.className = 'badge badge-lg bg-info';
                        badge.textContent = '🤔 EVALUAR';
                        break;
                    case 'RECHAZAR':
                        badge.className = 'badge badge-lg bg-danger';
                        badge.textContent = '❌ RECHAZAR';
                        break;
                    default:
                        badge.className = 'badge badge-lg bg-secondary';
                        badge.textContent = 'PROCESANDO';
                }
                
                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('detailsDisplay').style.display = 'block';
            }
            
            document.getElementById('successScreen').style.display = 'block';
        }
        
        // Auto-save to API
        async function saveToAPI() {
            if (!candidateToken) return false;
            
            try {
                await apiCall('/auto-save', 'POST', {
                    token: candidateToken,
                    respuestas: testData
                });
                return true;
            } catch (error) {
                console.error('API save failed:', error);
                return false;
            }
        }
        
        // CLEAVER questions data
        const CLEAVER_QUESTIONS = [
            { A: "Aventurero", B: "Adaptable", C: "Animoso", D: "Analítico" },
            { A: "Persistente", B: "Juguetón", C: "Persuasivo", D: "Plácido" },
            { A: "Sumiso", B: "Sociable", C: "Fuerte", D: "Seguro de sí mismo" },
            { A: "Considerado", B: "Controlado", C: "Competitivo", D: "Convincente" },
            { A: "Refrescante", B: "Reservado", C: "Recursivo", D: "Respetuoso" },
            { A: "Satisfecho", B: "Sensitivo", C: "Seguro", D: "Sencillo" },
            { A: "Calmado", B: "Confiado", C: "Convencedor", D: "Coherente" },
            { A: "Paciente", B: "Positivo", C: "Promotor", D: "Perfeccionista" }
        ];
        
        // KOSTICK questions
        const KOSTICK_QUESTIONS = [
            "Me gusta trabajar en equipo más que trabajar solo",
            "Prefiero seguir instrucciones claras antes que improvisar",
            "Me motiva más ayudar a otros que obtener reconocimiento personal",
            "Trabajo mejor bajo presión y con plazos ajustados",
            "Prefiero planificar detalladamente antes de actuar", // Crítica
            "Me adapto fácilmente a los cambios en el trabajo",
            "Me gusta asumir responsabilidades de liderazgo",
            "Prefiero trabajos que requieren atención al detalle",
            "Me siento cómodo tomando decisiones rápidas",
            "Disfruto de tareas que requieren creatividad e innovación",
            "Prefiero un ambiente de trabajo estructurado y predecible", // Crítica  
            "Me gusta competir y superar a mis compañeros",
            "Considero más importante la calidad que la velocidad", // Crítica
            "Me motivan los desafíos técnicos complejos",
            "Prefiero trabajar con personas conocidas que con extraños"
        ];
        
        // Situational questions
        const SITUATIONS = [
            {
                id: 1,
                scenario: "🚨 SITUACIÓN CRÍTICA: Un cliente le ofrece pagar en efectivo 'por debajo de la mesa' para evitar facturar el trabajo y así 'ahorrar impuestos'. ¿Qué haría usted?",
                options: {
                    A: "Acepto el trabajo sin factura para conseguir el cliente", // AUTOMATIC DISQUALIFIER - Tax evasion
                    B: "Le explico que debemos facturar todos los trabajos por política de la empresa",
                    C: "Consulto con mi supervisor sobre esta situación",
                    D: "Rechazo educadamente el trabajo si no acepta facturación"
                },
                critical: true,
                redFlag: 'A' // Option A = immediate rejection
            },
            {
                id: 2,
                scenario: "Un compañero de trabajo constantemente llega tarde y usted tiene que cubrir su trabajo extra. Esta situación se vuelve habitual y afecta su rendimiento.",
                options: {
                    A: "Hablo directamente con el compañero sobre el problema",
                    B: "Reporto la situación a mi supervisor inmediatamente",
                    C: "Continúo cubriendo sin decir nada para mantener la armonía",
                    D: "Busco una solución que beneficie al equipo completo"
                },
                critical: false
            },
            {
                id: 3,
                scenario: "Encuentra un error importante en la instalación eléctrica de un letrero que ya fue entregado al cliente. El error podría causar problemas de seguridad.",
                options: {
                    A: "Informo inmediatamente a mi supervisor sobre el error",
                    B: "Hablo primero con el compañero que hizo la instalación",
                    C: "Voy inmediatamente a corregir el error sin avisar",
                    D: "Documento el error y espero a ver si causa problemas"
                },
                critical: false
            },
            {
                id: 4,
                scenario: "🚨 SITUACIÓN CRÍTICA: Al terminar un trabajo de instalación, sobran algunos materiales valiosos (cables, conectores, etc.). ¿Qué hace con estos materiales?",
                options: {
                    A: "Me los llevo a casa porque sobraron del trabajo", // AUTOMATIC DISQUALIFIER - Theft
                    B: "Los devuelvo al almacén de la empresa inmediatamente",
                    C: "Los dejo en el lugar de trabajo para el próximo proyecto",
                    D: "Pregunto a mi supervisor qué hacer con los materiales"
                },
                critical: true,
                redFlag: 'A' // Option A = immediate rejection
            },
            {
                id: 5,
                scenario: "Un cliente está muy molesto porque el trabajo se retrasó dos días debido a problemas con los permisos municipales. Le exige una compensación económica.",
                options: {
                    A: "Le explico educadamente que el retraso no fue culpa nuestra",
                    B: "Le ofrezco una pequeña compensación de mi propio bolsillo",
                    C: "Inmediatamente consulto con mi supervisor sobre la situación",
                    D: "Le aseguro que terminaremos el trabajo con la mejor calidad posible"
                },
                critical: false
            }
        ];
        
        // Technical aptitudes and reasoning questions
        const APTITUDES = [
            {
                id: 1,
                type: "math",
                question: "Si necesita 3.5 metros de cable para cada letrero y debe instalar 8 letreros, ¿cuántos metros de cable necesita en total?",
                options: {
                    A: "24 metros",
                    B: "28 metros", // Correct answer
                    C: "32 metros",
                    D: "26 metros"
                },
                correct: "B"
            },
            {
                id: 2,
                type: "safety",
                question: "¿Cuál es la regla de oro para trabajar con electricidad?",
                options: {
                    A: "Trabajar siempre con herramientas aisladas",
                    B: "Verificar que no hay corriente antes de trabajar", // Correct answer
                    C: "Usar guantes de cuero siempre",
                    D: "Trabajar solo en días secos"
                },
                correct: "B"
            },
            {
                id: 3,
                type: "math",
                question: "Un letrero luminoso consume 150 watts por hora. Si funciona 12 horas diarias, ¿cuántos kilowatts consume por día?",
                options: {
                    A: "1.8 kW", // Correct answer
                    B: "1.5 kW",
                    C: "2.1 kW",
                    D: "1.2 kW"
                },
                correct: "A"
            },
            {
                id: 4,
                type: "technical",
                question: "¿Qué herramienta es ESENCIAL para verificar la seguridad en instalaciones eléctricas?",
                options: {
                    A: "Martillo aislado",
                    B: "Multímetro/probador de tensión", // Correct answer
                    C: "Destornillador magnético",
                    D: "Alicate universal"
                },
                correct: "B"
            },
            {
                id: 5,
                type: "safety",
                question: "Al trabajar en alturas superiores a 2 metros, ¿qué equipo es OBLIGATORIO usar?",
                options: {
                    A: "Casco y botas",
                    B: "Arnés de seguridad", // Correct answer
                    C: "Guantes antideslizantes",
                    D: "Gafas de protección"
                },
                correct: "B"
            },
            {
                id: 6,
                type: "math",
                question: "Si un rollo de soldadura pesa 2.5 kg y necesita 4 rollos completos para un proyecto, ¿cuál es el peso total del material?",
                options: {
                    A: "8 kg",
                    B: "9 kg",
                    C: "10 kg", // Correct answer
                    D: "12 kg"
                },
                correct: "C"
            },
            {
                id: 7,
                type: "technical",
                question: "¿Cuál es la diferencia principal entre soldadura MIG y soldadura con electrodo?",
                options: {
                    A: "El tipo de metal que se puede soldar",
                    B: "La temperatura de trabajo",
                    C: "El método de protección del arco", // Correct answer
                    D: "El grosor del material"
                },
                correct: "C"
            },
            {
                id: 8,
                type: "safety",
                question: "Antes de instalar un letrero eléctrico, ¿qué verificación es MÁS importante?",
                options: {
                    A: "Que el diseño sea atractivo",
                    B: "Que la estructura soporte el peso", // Correct answer
                    C: "Que tenga garantía del fabricante",
                    D: "Que sea visible desde lejos"
                },
                correct: "B"
            },
            {
                id: 9,
                type: "math",
                question: "Una escalera de 5 metros se apoya contra una pared a 4 metros de altura. ¿A qué distancia de la pared está la base de la escalera?",
                options: {
                    A: "2 metros",
                    B: "3 metros", // Correct answer (Pythagorean theorem: 5² = 4² + 3²)
                    C: "3.5 metros",
                    D: "1.5 metros"
                },
                correct: "B"
            },
            {
                id: 10,
                type: "technical",
                question: "¿Qué tipo de tubo se recomienda para proteger cables eléctricos en exteriores?",
                options: {
                    A: "Tubo de PVC", // Correct answer
                    B: "Tubo de cartón",
                    C: "Tubo de cobre",
                    D: "Sin protección"
                },
                correct: "A"
            },
            {
                id: 11,
                type: "safety",
                question: "¿Qué debe hacer PRIMERO si ve chispas en una instalación eléctrica?",
                options: {
                    A: "Rociar agua para apagar las chispas",
                    B: "Desconectar inmediatamente la energía", // Correct answer
                    C: "Llamar a los bomberos",
                    D: "Continuar trabajando con cuidado"
                },
                correct: "B"
            },
            {
                id: 12,
                type: "math",
                question: "Si debe instalar 6 letreros y cada uno toma 3.5 horas de trabajo, ¿cuántas horas necesita en total?",
                options: {
                    A: "18 horas",
                    B: "20 horas",
                    C: "21 horas", // Correct answer
                    D: "24 horas"
                },
                correct: "C"
            }
        ];
        
        // Initialize form
        async function initializeForm() {
            // First validate token and load candidate info
            const isValid = await validateTokenAndLoadCandidate();
            
            if (!isValid) {
                return; // Error screen will be shown
            }
            
            // Generate all questions
            generateCleaverQuestions();
            generateKostickQuestions();
            generateSituationsQuestions();
            generateAptitudesQuestions();

            // Initialize signature pad and declaration section
            initializeSignaturePad();
            setupDeclarationSection();

            // Restore UI state if we have saved data
            if (testData && Object.keys(testData).length > 0) {
                restoreUIState();
            }

            // Start auto-save
            startAutoSave();
            
            // Show the test screen
            showTestScreen();
        }
        
        // Generate CLEAVER questions
        function generateCleaverQuestions() {
            const container = document.getElementById('cleaverQuestions');
            
            CLEAVER_QUESTIONS.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Pregunta ${index + 1}</span>
                    </div>
                    <div class="question-body">
                        <div class="cleaver-words">
                            <div class="word-card" data-option="A" data-question="${index}">
                                <div class="word-letter">A</div>
                                <div class="word-text">${question.A}</div>
                            </div>
                            <div class="word-card" data-option="B" data-question="${index}">
                                <div class="word-letter">B</div>
                                <div class="word-text">${question.B}</div>
                            </div>
                            <div class="word-card" data-option="C" data-question="${index}">
                                <div class="word-letter">C</div>
                                <div class="word-text">${question.C}</div>
                            </div>
                            <div class="word-card" data-option="D" data-question="${index}">
                                <div class="word-letter">D</div>
                                <div class="word-text">${question.D}</div>
                            </div>
                        </div>
                        
                        <div class="choice-section">
                            <div class="choice-grid">
                                <div class="choice-column">
                                    <div class="choice-label mas">
                                        🔵 MÁS describe
                                    </div>
                                    <div class="choice-buttons">
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="A">A</button>
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="B">B</button>
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="C">C</button>
                                        <button type="button" class="choice-btn" data-type="mas" data-question="${index}" data-option="D">D</button>
                                    </div>
                                </div>
                                
                                <div class="choice-separator"></div>
                                
                                <div class="choice-column">
                                    <div class="choice-label menos">
                                        🔴 MENOS describe
                                    </div>
                                    <div class="choice-buttons">
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="A">A</button>
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="B">B</button>
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="C">C</button>
                                        <button type="button" class="choice-btn" data-type="menos" data-question="${index}" data-option="D">D</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
            
            // Add event listeners for CLEAVER choices
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', handleCleaverChoice);
            });
        }
        
        // Handle CLEAVER choice selection
        function handleCleaverChoice(event) {
            const button = event.target;
            const type = button.dataset.type;
            const question = parseInt(button.dataset.question);
            const option = button.dataset.option;
            
            // Remove selection from other buttons in the same group
            document.querySelectorAll(`[data-type="${type}"][data-question="${question}"]`)
                .forEach(btn => btn.classList.remove('selected'));
            
            // Add selection to clicked button
            button.classList.add('selected');
            
            // Save choice
            if (!testData.cleaver[question]) {
                testData.cleaver[question] = {};
            }
            testData.cleaver[question][type] = option;
            
            // Update word card styling
            updateCleaverWordCards(question);
            
            // Auto-save
            saveData();
        }
        
        // Update word card visual feedback
        function updateCleaverWordCards(questionIndex) {
            const questionData = testData.cleaver[questionIndex];
            if (!questionData) return;
            
            // Reset all cards for this question
            document.querySelectorAll(`[data-question="${questionIndex}"].word-card`)
                .forEach(card => {
                    card.classList.remove('selected-mas', 'selected-menos', 'selected-both');
                });
            
            // Apply styling based on selections
            if (questionData.mas) {
                const masCard = document.querySelector(`[data-question="${questionIndex}"][data-option="${questionData.mas}"].word-card`);
                if (masCard) masCard.classList.add('selected-mas');
            }
            
            if (questionData.menos) {
                const menosCard = document.querySelector(`[data-question="${questionIndex}"][data-option="${questionData.menos}"].word-card`);
                if (menosCard) menosCard.classList.add('selected-menos');
            }
            
            // Check for same selection (warning)
            if (questionData.mas === questionData.menos && questionData.mas) {
                const bothCard = document.querySelector(`[data-question="${questionIndex}"][data-option="${questionData.mas}"].word-card`);
                if (bothCard) {
                    bothCard.classList.remove('selected-mas', 'selected-menos');
                    bothCard.classList.add('selected-both');
                }
            }
        }
        
        // Generate KOSTICK questions
        function generateKostickQuestions() {
            const container = document.getElementById('kostickQuestions');
            
            KOSTICK_QUESTIONS.forEach((question, index) => {
                const isCritical = [4, 10, 12].includes(index);
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                if (isCritical) {
                    questionCard.style.borderLeft = '4px solid var(--warning-color)';
                }
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Pregunta ${index + 1}</span>
                        ${isCritical ? '<span class="badge bg-warning text-dark ms-2">⚠️ Importante</span>' : ''}
                    </div>
                    <div class="question-body">
                        <p class="mb-3">${question}</p>
                        
                        <div class="row g-2">
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="TD" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'TD')">
                                    <span class="form-selectgroup-label">
                                        <strong>TD</strong><br>
                                        <small>Totalmente en Desacuerdo</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="D" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'D')">
                                    <span class="form-selectgroup-label">
                                        <strong>D</strong><br>
                                        <small>En Desacuerdo</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="N" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'N')">
                                    <span class="form-selectgroup-label">
                                        <strong>N</strong><br>
                                        <small>Neutral</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="A" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'A')">
                                    <span class="form-selectgroup-label">
                                        <strong>A</strong><br>
                                        <small>De Acuerdo</small>
                                    </span>
                                </label>
                            </div>
                            <div class="col">
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="kostick_${index}" value="TA" class="form-selectgroup-input" onchange="updateKostickChoice(${index}, 'TA')">
                                    <span class="form-selectgroup-label">
                                        <strong>TA</strong><br>
                                        <small>Totalmente de Acuerdo</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
        }
        
        // Generate situational questions
        function generateSituationsQuestions() {
            const container = document.getElementById('situationsQuestions');
            
            SITUATIONS.forEach((situation, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                if (situation.critical) {
                    questionCard.style.borderLeft = '4px solid var(--danger-color)';
                }
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Situación ${index + 1}</span>
                        ${situation.critical ? '<span class="badge bg-danger ms-2">🚨 Crítica</span>' : ''}
                    </div>
                    <div class="question-body">
                        <div class="alert alert-info mb-3">
                            ${situation.scenario}
                        </div>
                        
                        <p class="fw-bold mb-3">¿Qué haría?</p>
                        
                        <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="A" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'A')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>A)</strong> ${situation.options.A}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="B" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'B')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>B)</strong> ${situation.options.B}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="C" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'C')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>C)</strong> ${situation.options.C}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="situation_${index}" value="D" class="form-selectgroup-input" onchange="updateSituationChoice(${index}, 'D')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>D)</strong> ${situation.options.D}
                                    </span>
                                </span>
                            </label>
                        </div>
                    </div>
                `;
                
                container.appendChild(questionCard);
            });
        }
        
        // Generate aptitudes questions
        function generateAptitudesQuestions() {
            const container = document.getElementById('aptitudesQuestions');

            APTITUDES.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';

                // Add type indicator color
                let typeColor = '';
                let typeIcon = '';
                switch(question.type) {
                    case 'math':
                        typeColor = 'success';
                        typeIcon = '🔢';
                        break;
                    case 'safety':
                        typeColor = 'danger';
                        typeIcon = '🛡️';
                        break;
                    case 'technical':
                        typeColor = 'primary';
                        typeIcon = '⚙️';
                        break;
                }

                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Pregunta ${index + 1}</span>
                        <span class="badge bg-${typeColor} ms-2">${typeIcon} ${question.type.charAt(0).toUpperCase() + question.type.slice(1)}</span>
                    </div>
                    <div class="question-body">
                        <div class="alert alert-light mb-3">
                            <strong>${question.question}</strong>
                        </div>

                        <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="aptitud_${index}" value="A" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, 'A')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>A)</strong> ${question.options.A}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="aptitud_${index}" value="B" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, 'B')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>B)</strong> ${question.options.B}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="aptitud_${index}" value="C" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, 'C')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>C)</strong> ${question.options.C}
                                    </span>
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="aptitud_${index}" value="D" class="form-selectgroup-input" onchange="updateAptitudeChoice(${index}, 'D')">
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span>
                                        <strong>D)</strong> ${question.options.D}
                                    </span>
                                </span>
                            </label>
                        </div>
                    </div>
                `;

                container.appendChild(questionCard);
            });
        }
        
        // Handle choice updates
        function updateKostickChoice(questionIndex, value) {
            testData.kostick[questionIndex] = value;
            saveData();
        }
        
        function updateSituationChoice(questionIndex, value) {
            testData.situations[questionIndex] = value;
            saveData();
        }
        
        function updateAptitudeChoice(questionIndex, value) {
            testData.aptitudes[questionIndex] = value;
            saveData();
        }
        
        // Navigation functions
        function nextSection() {
            if (currentSection < totalSections) {
                // Validate current section before proceeding
                if (!validateCurrentSection()) {
                    return;
                }

                // Persist theme across navigation
                persistThemeAcrossSections();

                // Hide current section
                document.getElementById(`section${currentSection}`).classList.remove('active');

                // Update progress
                document.getElementById(`step${currentSection}`).classList.remove('active');
                document.getElementById(`step${currentSection}`).classList.add('completed');
                if (currentSection < totalSections) {
                    document.getElementById(`line${currentSection}`).classList.add('completed');
                }

                // Show next section
                currentSection++;
                document.getElementById(`section${currentSection}`).classList.add('active');
                document.getElementById(`step${currentSection}`).classList.add('active');

                // Ensure signature pad is properly themed if we're on section 5
                if (currentSection === 5) {
                    setTimeout(() => {
                        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                        updateSignaturePadTheme(currentTheme);
                    }, 100);
                }

                // Scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        // Validate current section
        function validateCurrentSection() {
            switch (currentSection) {
                case 1: // CLEAVER
                    return validateCleaverSection();
                case 2: // KOSTICK
                    return validateKostickSection();
                case 3: // SITUATIONS
                    return validateSituationsSection();
                case 4: // APTITUDES
                    return validateAptitudesSection();
                case 5: // DECLARATION & SIGNATURE
                    return validateDeclarationSection();
                default:
                    return true;
            }
        }
        
        function validateCleaverSection() {
            const totalQuestions = CLEAVER_QUESTIONS.length;
            const completedQuestions = Object.keys(testData.cleaver || {}).filter(questionIndex => {
                const questionData = testData.cleaver[questionIndex];
                return questionData && questionData.mas && questionData.menos;
            }).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las preguntas. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function validateKostickSection() {
            const totalQuestions = KOSTICK_QUESTIONS.length;
            const completedQuestions = Object.keys(testData.kostick || {}).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las preguntas. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function validateSituationsSection() {
            const totalQuestions = SITUATIONS.length;
            const completedQuestions = Object.keys(testData.situations || {}).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las situaciones. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function validateAptitudesSection() {
            const totalQuestions = APTITUDES.length;
            const completedQuestions = Object.keys(testData.aptitudes || {}).length;
            
            if (completedQuestions < totalQuestions) {
                alert(`Por favor complete todas las aptitudes. Completadas: ${completedQuestions}/${totalQuestions}`);
                return false;
            }
            return true;
        }
        
        function prevSection() {
            if (currentSection > 1) {
                // Persist theme across navigation
                persistThemeAcrossSections();

                // Hide current section
                document.getElementById(`section${currentSection}`).classList.remove('active');
                document.getElementById(`step${currentSection}`).classList.remove('active');

                // Update progress
                currentSection--;
                document.getElementById(`step${currentSection}`).classList.remove('completed');
                document.getElementById(`step${currentSection}`).classList.add('active');
                if (currentSection < totalSections) {
                    document.getElementById(`line${currentSection}`).classList.remove('completed');
                }

                // Show previous section
                document.getElementById(`section${currentSection}`).classList.add('active');

                // Scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        // Auto-save functionality
        function startAutoSave() {
            setInterval(saveData, 30000); // Save every 30 seconds
        }
        
        async function saveData() {
            let saveSuccess = false;
            
            // Show saving indicator
            showSaveIndicator(true);
            
            // Always save to localStorage as backup
            try {
                localStorage.setItem('evaluacion_psicometrica', JSON.stringify(testData));
                saveSuccess = true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
            
            // Try to save to API
            if (candidateToken && navigator.onLine) {
                try {
                    await saveToAPI();
                    saveSuccess = true;
                } catch (error) {
                    console.error('Error saving to API:', error);
                    // Don't show error to user, localStorage backup is available
                }
            }
            
            if (saveSuccess) {
                showSaveIndicator(false);
            } else {
                // Hide saving indicator if failed
                document.getElementById('saveIndicator').style.display = 'none';
            }
        }
        
        function loadSavedData() {
            // This function is now handled in validateTokenAndLoadCandidate
            // keeping for backward compatibility
            try {
                const saved = localStorage.getItem('evaluacion_psicometrica');
                if (saved && (!testData || Object.keys(testData).length === 0)) {
                    testData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading localStorage data:', error);
            }
        }
        
        function restoreUIState() {
            // Restore CLEAVER selections
            Object.keys(testData.cleaver || {}).forEach(questionIndex => {
                const questionData = testData.cleaver[questionIndex];
                
                if (questionData.mas) {
                    const masBtn = document.querySelector(`[data-type="mas"][data-question="${questionIndex}"][data-option="${questionData.mas}"]`);
                    if (masBtn) masBtn.classList.add('selected');
                }
                
                if (questionData.menos) {
                    const menosBtn = document.querySelector(`[data-type="menos"][data-question="${questionIndex}"][data-option="${questionData.menos}"]`);
                    if (menosBtn) menosBtn.classList.add('selected');
                }
                
                updateCleaverWordCards(parseInt(questionIndex));
            });
            
            // Restore KOSTICK selections
            Object.keys(testData.kostick || {}).forEach(questionIndex => {
                const value = testData.kostick[questionIndex];
                const radio = document.querySelector(`input[name="kostick_${questionIndex}"][value="${value}"]`);
                if (radio) radio.checked = true;
            });
            
            // Restore SITUATIONS selections
            Object.keys(testData.situations || {}).forEach(questionIndex => {
                const value = testData.situations[questionIndex];
                const radio = document.querySelector(`input[name="situation_${questionIndex}"][value="${value}"]`);
                if (radio) radio.checked = true;
            });
            
            // Restore APTITUDES selections
            Object.keys(testData.aptitudes || {}).forEach(questionIndex => {
                const value = testData.aptitudes[questionIndex];
                const radio = document.querySelector(`input[name="aptitud_${questionIndex}"][value="${value}"]`);
                if (radio) radio.checked = true;
            });
        }
        
        function showSaveIndicator(saving = false) {
            const indicator = document.getElementById('saveIndicator');
            
            if (saving) {
                indicator.innerHTML = '💾 Guardando...';
                indicator.style.background = 'var(--primary-color)';
                indicator.style.display = 'block';
            } else {
                indicator.innerHTML = '✓ Guardado automáticamente';
                indicator.style.background = 'var(--success-color)';
                indicator.style.display = 'block';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        async function submitForm() {
            // Final validation
            if (!validateCurrentSection()) {
                return;
            }
            
            // Show completion confirmation
            const confirmSubmit = confirm('¿Está seguro de que desea finalizar la evaluación? No podrá hacer cambios después de enviarla.');
            
            if (!confirmSubmit) {
                return;
            }
            
            // Calculate total time spent
            const tiempoTotal = Math.round((Date.now() - startTime) / 1000); // in seconds
            
            // Prepare personal data
            const datosPersonales = {
                nombre: candidateInfo?.nombre || 'No especificado',
                email: candidateInfo?.email || '',
                puesto: candidateInfo?.puesto || 'No especificado',
                fechaEvaluacion: new Date().toISOString()
            };
            
            // Show loading state
            const submitBtn = document.querySelector('[onclick="submitForm()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Enviando...
            `;
            
            try {
                // Submit to API
                const response = await apiCall('/submit-test', 'POST', {
                    token: candidateToken,
                    respuestas: testData,
                    datosPersonales: datosPersonales,
                    tiempoTotal: tiempoTotal
                });
                
                // Save final submission to localStorage as backup
                const submissionData = {
                    timestamp: new Date().toISOString(),
                    cleaver: testData.cleaver,
                    kostick: testData.kostick,
                    situations: testData.situations,
                    aptitudes: testData.aptitudes,
                    datosPersonales: datosPersonales,
                    tiempoTotal: tiempoTotal,
                    metadata: {
                        userAgent: navigator.userAgent,
                        screenResolution: `${screen.width}x${screen.height}`,
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    results: response.results || null
                };
                
                localStorage.setItem('evaluacion_psicometrica_final', JSON.stringify(submissionData));
                
                // Show success screen with results
                showSuccessScreen(response.results);
                
            } catch (error) {
                console.error('Submission failed:', error);
                
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                // Show error but offer offline backup
                const retrySubmit = confirm(
                    `❌ Error al enviar la evaluación: ${error.message}\n\n` +
                    `¿Desea intentar nuevamente?\n\n` +
                    `• Sí: Intentar envío nuevamente\n` +
                    `• No: Guardar localmente y contactar soporte`
                );
                
                if (retrySubmit) {
                    // Retry submission
                    submitForm();
                } else {
                    // Save locally and show instructions
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        token: candidateToken,
                        respuestas: testData,
                        datosPersonales: datosPersonales,
                        tiempoTotal: tiempoTotal,
                        error: error.message
                    };
                    
                    localStorage.setItem('evaluacion_psicometrica_backup', JSON.stringify(backupData));
                    
                    alert(
                        `💾 Sus respuestas han sido guardadas localmente.\n\n` +
                        `Por favor contacte a soporte técnico con el siguiente código:\n` +
                        `ERROR-${Date.now()}\n\n` +
                        `📧 Correo: rrhh@anunciosluminosos.com\n` +
                        `📞 Teléfono: [NÚMERO DE SOPORTE]`
                    );
                }
            }
        }
        
        // Signature pad functionality
        function initializeSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Set canvas properties based on current theme
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            ctx.strokeStyle = currentTheme === 'dark' ? '#ffffff' : '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);

            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;

                ctx.beginPath();
                ctx.moveTo(x, y);

                // Mark that signature has started
                checkSignatureComplete();
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();

                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;

                ctx.lineTo(x, y);
                ctx.stroke();

                // Save signature data
                testData.signature = canvas.toDataURL();
                checkSignatureComplete();
            }

            function stopDrawing() {
                isDrawing = false;
            }

            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function clearSignature() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            testData.signature = null;
            checkSignatureComplete();
        }

        function setupDeclarationSection() {
            // Set current date and time
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const timeStr = now.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;

            // Set candidate name if available
            if (candidateInfo && candidateInfo.nombre) {
                document.getElementById('candidateNameSignature').textContent = candidateInfo.nombre;
            }

            // Add event listeners for declaration checkboxes
            const checkboxes = document.querySelectorAll('#section5 input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    testData.declaration[this.id] = this.checked;
                    checkDeclarationComplete();
                });
            });

            // Initial check
            checkDeclarationComplete();
        }

        function checkDeclarationComplete() {
            const checkboxes = document.querySelectorAll('#section5 input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkSignatureComplete();
            return allChecked;
        }

        function checkSignatureComplete() {
            const declarationComplete = checkDeclarationComplete();
            const signatureExists = testData.signature && testData.signature.length > 0;

            const submitBtn = document.getElementById('finalSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = !(declarationComplete && signatureExists);
            }
        }

        function validateDeclarationSection() {
            const declarationComplete = checkDeclarationComplete();
            const signatureExists = testData.signature && testData.signature.length > 0;

            if (!declarationComplete) {
                alert('⚠️ Por favor marque todas las declaraciones requeridas antes de continuar.');
                return false;
            }

            if (!signatureExists) {
                alert('✍️ Por favor proporcione su firma digital antes de finalizar la evaluación.');
                return false;
            }

            return true;
        }

        // Network monitoring
        function monitorNetworkStatus() {
            const networkIndicator = document.getElementById('networkIndicator');
            
            function updateNetworkStatus() {
                if (!navigator.onLine) {
                    networkIndicator.style.display = 'block';
                } else {
                    networkIndicator.style.display = 'none';
                }
            }
            
            // Check initial status
            updateNetworkStatus();
            
            // Listen for network changes
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme first
            initializeTheme();

            // Initialize other systems
            monitorNetworkStatus();
            initializeForm();
        });
    </script>
</body>
</html>